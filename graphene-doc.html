<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../graphene-client/graphene-client.html">
<dom-module id="graphene-doc">
  <template>
    <graphene-client role="client"></graphene-client>
  </template>
  <script>
  (function() {
    'use strict';
    var appName = apiSettings.server.appName;

    var sCache  = localStorage.getItem('graphene-doc ('+appName+')');
    var cache  = sCache !== null ? JSON.parse(sCache):{};

    function saveDocCache (action,doc){
      cache[action] = doc;
      localStorage.setItem('graphene-doc ('+appName+')',JSON.stringify(cache));
    }

    Polymer({
      is: 'graphene-doc',

      attached:function(){
        this._client = this.$$('[role = client]');
      },

      /**
       * sets the action name
       * */
      setActionName:function(action){
        this.actionName = action;
      },

      _onActionNameChange : function(newName){
        if(!(!!cache[newName])){
          this._client.gFetch('/system/doc/?action=' + this.actionName + '&detail=' + this._getDetailFlag())
            .then(function(response){
              this.doc = response.DocAction;
              this.fire('doc-update',this.doc);
              saveDocCache(newName,this.doc);
            }.bind(this))
            .catch(function(err){
              this.err = err;
              console.error(err);
            }.bind(this))
        }else{
          this.doc = cache[newName];
          this.fire('doc-update',this.doc);
        }
      },

      getInterface:function(){
        return this.doc.interface;
      },

      _getDetailFlag: function () {
        return this.detail ? 1 : 0;
      },

      properties: {
        actionName : {type:String, observer:'_onActionNameChange'},
        doc        : Object,
        detail: {type: Boolean, value: false},
        _client    : Object
      }
    });
  })();
  </script>
</dom-module>
