<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../graphene-client/graphene-client.html">
<dom-module id="graphene-doc">
  <template>
    <graphene-client role="client" on-client-ready="_onClientReady"></graphene-client>
  </template>
  <script>
  (function() {
    'use strict';
    var appName = apiSettings.server.appName;

    var sCache  = localStorage.getItem('graphene-doc ('+appName+')');
    var cache  = sCache !== null ? JSON.parse(sCache):{};

    function saveDocCache (action,doc){
      cache[action] = doc;
      localStorage.setItem('graphene-doc ('+appName+')',JSON.stringify(cache));
    }

    Polymer({
      is: 'graphene-doc',

      attached: function () {
      },

      _onClientReady: function () {
        this.fire('doc-ready');
      },

      _getClient: function () {
        return this.$$('[role = client]');
      },
      /**
       * sets the action name
       * */
      setActionName:function(action){
        this.actionName = action;
      },

        _onActionNameChange: function () {
            this.fetchDoc();
      },

        fetchDoc: function () {
            if (!!this._getClient() && !!this.actionName) {
                if (!(!!cache[this.actionName])) {
                    this._getClient().gFetch('/system/doc/?action=' + this.actionName + '&detail=' + this._getDetailFlag())
                            .then(function (response) {
                                this.doc = response.DocAction;
                                this.fire('doc-update', this.doc);
                                saveDocCache(this.actionName, this.doc);
                            }.bind(this))
                            .catch(function (err) {
                                this.err = err;
                                console.error(err);
                            }.bind(this))
                } else {
                    this.doc = cache[this.actionName];
                    this.fire('doc-update', this.doc);
                }
            } else {
                console.log('waiting for more informations\nClient: ', this._getClient(), '\nAction name: ', this.actionName)
            }
        },

      getInterface:function(){
        return this.doc.interface;
      },

      _getDetailFlag: function () {
        return this.detail ? 1 : 0;
      },

      properties: {
        actionName : {type:String, observer:'_onActionNameChange'},
        doc        : Object,
        detail: {type: Boolean, value: false},
      }
    });
  })();
  </script>
</dom-module>
